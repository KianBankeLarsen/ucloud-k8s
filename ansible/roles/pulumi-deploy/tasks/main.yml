---
- name: Clone GitHub repository
  git:
    repo: "https://github.com/KianBankeLarsen/CTF-Platform"
    dest: "~/CTF-Platform"
    update: yes

- name: install npm packages
  shell: |
    source ~/.nvm/nvm.sh
    npm install
  args:
    chdir: "~/CTF-Platform/src"
    executable: /bin/bash


- name: Source nvm and check nodejs version
  shell: |
    source ~/.nvm/nvm.sh
    node --version
  register: node_version
  args:
    executable: /bin/bash

- name: Log nodejs version to stdout
  debug:
    msg: "Node.js version is {{ node_version.stdout }}"


- name: Deploy stacks
  vars:
    pulumi_passphrase: "{{ lookup('file', '../pulumi_passphrase') }}"
  block:
    - name: Source environment and deploy Pulumi stacks
      shell: |
        source ~/.nvm/nvm.sh
        export PATH=$PATH:$HOME/.pulumi/bin
        pulumi login --local
        pulumi stack select ucloud --create
        pulumi up -y
      args:
        chdir: "{{ item }}"
        executable: /bin/bash
      environment:
        PULUMI_CONFIG_PASSPHRASE: "{{ pulumi_passphrase }}"
      loop:
        - "~/CTF-Platform/src/infrastructure"
        - "~/CTF-Platform/src/certificates"
        - "~/CTF-Platform/src/monitoring"
        - "~/CTF-Platform/src/authentication"
        - "~/CTF-Platform/src/application"
